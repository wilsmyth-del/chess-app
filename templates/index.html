<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chess</title>

    <link rel="stylesheet" href="/static/vendor/chessboard-1.0.0.min.css" />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    


    <div class="page-header">
      <h1>Chess</h1>
      <button id="theme-toggle" aria-pressed="false">Dark Mode</button>
      <div id="persona-indicator" class="persona-indicator">Persona: Student</div>
    </div>

    <div class="layout">
          <div class="left-col">
            <div class="board-wrap" style="position:relative">
              <div class="board-top-controls">
                <button id="play-engine-btn" class="ctrl small play-top">Start Game</button>
              </div>
              <div id="board-container">
                <div id="board"></div>
              </div>

              <!-- Bottom controls: Export FEN and Download PGN (side-by-side under board) -->
              <div class="board-bottom-controls">
                <button id="export-fen-btn" class="ctrl small">Export FEN</button>
                <button id="save-pgn-btn" class="ctrl small">Download PGN</button>
              </div>

              <!-- Small floating Tools button (links to full Tools page) -->
              <a id="open-tools-btn" href="/test_personas" target="_blank" rel="noopener noreferrer" title="Tools" style="position:absolute;right:10px;bottom:10px;z-index:60;padding:8px 10px;border-radius:6px;background:var(--card-accent,#28a745);color:#fff;text-decoration:none;font-size:13px;box-shadow:0 2px 6px rgba(0,0,0,0.15)">Tools</a>
            <div class="captured-trays">
              <div class="captured-tray">
                  <div id="tray-white" class="tray-items"></div>
                  <!-- tray image only -->
              </div>
              <div class="captured-tray">
                  <div id="tray-black" class="tray-items"></div>
                  <!-- tray image only -->
              </div>
            </div>
          </div>
      </div>

      <div class="right-col">
        <div class="turn-area">
            <div id="status" class="turn-status"></div>
            <div id="result-indicator"></div>
          </div>

          <!-- Simplified UI: three states only: SETUP, IN_GAME, RESULT -->
          <div id="setup-panel" class="panel">
            <h3>Setup</h3>
            <div style="margin-top:8px">
              <label>Player name: <input type="text" id="player-name" placeholder="Your name" /></label>
            </div>
            <div class="form-group" style="margin-top:12px">
              <label>Opponent</label>
              <select id="engine-persona" style="width:100%" title="Select your opponent">
                <option value="Grasshopper">Grasshopper</option>
                <option value="Student" selected>Student</option>
                <option value="Adept">Adept</option>
                <option value="Ninja">Ninja</option>
                <option value="Sensei">Sensei</option>
              </select>
              <div class="hint" style="font-size:0.8em; color:#888; margin-top:4px">
                Each opponent has a unique playing style and skill level.
              </div>
            </div>
            <!-- Flip board option removed (never used) -->
            <!-- Start Game control consolidated to the board header `play-engine-btn` -->
          </div>

          <div id="in-game-panel" class="panel" style="display:none">
            <h3>In Game</h3>
            <div style="margin-top:8px">
              <button id="end-game-btn" class="ctrl danger">End Game</button>
            </div>
          </div>

          <div id="result-panel" class="panel" style="display:none">
            <h3>Result</h3>
            <div id="result-banner" style="margin-top:8px;font-weight:700"></div>
            <div id="result-reason" style="margin-top:6px;color:var(--muted)"></div>
            <div style="margin-top:8px">
              <button id="download-final-pgn" class="ctrl small">Download PGN</button>
              <button id="new-game-btn" class="ctrl small">New Game</button>
            </div>
          </div>

            <div class="accordion">
          <div class="accordion-item">
            <button class="accordion-toggle">Controls</button>
            <div class="accordion-content">
              <label>Player color:
                <select id="player-color">
                  <option value="white">White (bottom)</option>
                  <option value="black">Black (bottom)</option>
                </select>
              </label>
              <!-- Player color chooser is above -->
              <!-- Opponent/persona selection moved to Setup panel; single source of truth. -->
              <!-- Thinking speed selector removed: personas use an internal engine-time default -->
              <div id="players-display" style="margin-top:8px; font-weight:600"></div>
              <!-- Captured trays update controls removed; captured pieces update automatically during play -->
                  <!-- Free Board controls moved into Free tab -->
              <div class="hint" style="margin-top:8px">Tip: Use the Arrow keys to step through moves.</div>
            </div>
          </div>

          <!-- Engine controls removed; persona and game start/stop handled from Controls -->

          </div>
          <!-- Move list removed per user request -->
        </div>
      </div>
    </div>

    <script src="/static/vendor/jquery-3.6.0.min.js"></script>
    <script src="/static/vendor/chessboard-1.0.0.min.js"></script>
    <script src="/static/vendor/chess.min.js"></script>

    <!-- Promotion modal (hidden by default) -->
    <div id="promotion-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="promo-title">
      <div class="modal-content">
        <div id="promo-title">Choose promotion piece</div>
        <div class="promo-buttons">
          <button class="promo-btn" data-piece="q"><img class="promo-img" alt="Queen"/><span class="promo-label">Q</span></button>
          <button class="promo-btn" data-piece="r"><img class="promo-img" alt="Rook"/><span class="promo-label">R</span></button>
          <button class="promo-btn" data-piece="b"><img class="promo-img" alt="Bishop"/><span class="promo-label">B</span></button>
          <button class="promo-btn" data-piece="n"><img class="promo-img" alt="Knight"/><span class="promo-label">N</span></button>
        </div>
        <button id="promo-cancel" class="promo-cancel">Cancel</button>
      </div>
    </div>

    <!-- popout modal removed; move list is permanent below the right-side accordion -->

    <script>
      // Expose server-side v1 flag to client JS
      window.V1_MODE = {{ 'true' if v1_mode else 'false' }};
      window.DEBUG_MODE = {{ 'true' if debug_mode else 'false' }};
    </script>
    {% if debug_mode %}
    <!-- Development-only debug panel (read-only). Visible only when Flask debug is enabled. -->
    <div id="dev-debug-panel" style="position:fixed;right:8px;bottom:8px;z-index:1000;background:#fff;border:1px solid #ccc;padding:8px;font-size:12px;max-width:300px;box-shadow:0 2px 6px rgba(0,0,0,0.2);opacity:0.95">
      <div style="font-weight:700;margin-bottom:6px">DEV: Debug Panel</div>
      <div id="dev-preset-name">Preset: -</div>
      <div id="dev-engine-time">Engine time: -</div>
      <div id="dev-engine-skill">Engine skill: -</div>
      <div id="dev-randomness">Randomness/blunder persona: -</div>
      <div id="dev-game-status">Game: -</div>
    </div>
    <script>
    (function(){
      function refresh(){
        // Read selected opponent/persona from the DOM if available
        var selEl = document.getElementById('engine-persona');
        var sel = selEl ? selEl.value : null;
        // Fetch dev presets (will be available only when debug endpoints are enabled)
        fetch('/api/dev/presets').then(function(r){ return r.json(); }).then(function(d){
          if(d && d.ok && d.presets && sel){
            var p = d.presets[sel.toLowerCase()];
            if(p){
              document.getElementById('dev-preset-name').textContent = 'Preset: ' + (p.display_name || sel);
              document.getElementById('dev-engine-time').textContent = 'Engine time: ' + (p.engine_time == null ? '-' : p.engine_time);
              document.getElementById('dev-engine-skill').textContent = 'Engine skill: ' + (p.engine_skill == null ? '-' : p.engine_skill);
              document.getElementById('dev-randomness').textContent = 'Randomness/blunder persona: ' + (p.engine_persona || '-');
            }
          }
        }).catch(function(){});

        // Fetch simple game lifecycle info
        fetch('/api/dev/game_status').then(function(r){ return r.json(); }).then(function(d){
          if(d && d.ok){
            var txt = 'Status: ' + (d.status || '-') + (d.status === 'ENDED' ? (' | ' + (d.end_reason || '') + ' | ' + (d.result || '')) : '');
            document.getElementById('dev-game-status').textContent = txt;
          }
        }).catch(function(){});
      }
      // initial refresh and periodic updates
      setTimeout(refresh, 200);
      setInterval(refresh, 2000);
    })();
    </script>
    {% endif %}
    <script src="/static/main.js?v={{ main_js_version }}"></script>
  </body>
</html>
