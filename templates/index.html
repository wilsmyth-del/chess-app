<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chess</title>

    <link rel="stylesheet" href="/static/vendor/chessboard-1.0.0.min.css" />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <!-- Dimming overlay for game focus mode -->
    <div class="game-focus-overlay"></div>


    <div class="page-header">
      <h1>Chess</h1>
      <button id="theme-toggle" aria-pressed="false">Dark Mode</button>
      <div id="persona-indicator" class="persona-indicator">Persona: Student</div>
    </div>

    <div class="layout">
          <div class="left-col">
            <div class="board-wrap" style="position:relative">
              <div id="board-container">
                <div id="board"></div>
              </div>

              <!-- Bottom controls: Export FEN (Download PGN removed; server auto-saves) -->
              <div class="board-bottom-controls">
                <button id="export-fen-btn" class="ctrl small">Export FEN</button>
              </div>

              <!-- Small floating Tools button (removed for public release) -->
          </div>
      </div>

          <div class="right-col">
            <div class="captured-trays" style="margin-bottom:15px; padding:10px; background:rgba(0,0,0,0.1); border-radius:4px; display:flex; flex-direction:column; gap:8px;">
              <div class="captured-tray" style="display:flex; align-items:center; min-height:24px;">
                <div id="tray-white" class="tray-items" style="display:flex; flex-wrap:wrap;"></div>
              </div>
              <div class="captured-tray" style="display:flex; align-items:center; min-height:24px;">
                <div id="tray-black" class="tray-items" style="display:flex; flex-wrap:wrap;"></div>
              </div>
            </div>
        <div class="turn-area">
            <div id="status" class="turn-status"></div>
            <div id="result-indicator"></div>
          </div>

          <!-- Simplified UI: three states only: SETUP, IN_GAME, RESULT -->
          <div id="setup-panel" class="panel">
            <h3>New Game</h3>

            <div class="form-group">
              <label>Player Name</label>
              <input type="text" id="player-name" placeholder="Guest" />
            </div>
            <input type="hidden" id="player-color" value="white" />
            <div class="form-group">
              <label>I want to play as...</label>
              <div id="player-color-pills" style="display:flex; gap:8px; margin-top:8px">
                <button type="button" data-value="white" class="pill-btn" style="padding:8px 12px;border-radius:18px;border:1px solid #666;background:#222;color:#fff">White (First Move)</button>
                <button type="button" data-value="black" class="pill-btn" style="padding:8px 12px;border-radius:18px;border:1px solid #666;background:transparent;color:#ccc">Black</button>
              </div>
            </div>
            <input type="hidden" id="engine-persona" value="Student" />
            <div class="form-group">
              <label>Opponent</label>
              <div id="engine-persona-pills" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px">
                <button type="button" data-value="Grasshopper" class="pill-btn" style="padding:8px 12px;border-radius:18px;border:1px solid #666;background:transparent;color:#ccc">Grasshopper</button>
                <button type="button" data-value="Student" class="pill-btn" style="padding:8px 12px;border-radius:18px;border:1px solid #666;background:#222;color:#fff">Student</button>
                <button type="button" data-value="Adept" class="pill-btn" style="padding:8px 12px;border-radius:18px;border:1px solid #666;background:transparent;color:#ccc">Adept</button>
                <button type="button" data-value="Ninja" class="pill-btn" style="padding:8px 12px;border-radius:18px;border:1px solid #666;background:transparent;color:#ccc">Ninja</button>
                <button type="button" data-value="Sensei" class="pill-btn" style="padding:8px 12px;border-radius:18px;border:1px solid #666;background:transparent;color:#ccc">Sensei</button>
              </div>
            </div>
            <div style="margin-top:20px;">
              <button id="main-start-btn" class="ctrl action large" style="width:100%; padding:12px; font-size:1.1em;">Start Game</button>
            </div>
            <!-- Laboratory Mode removed for public release -->
          </div>

          <div id="in-game-panel" class="panel" style="display:none">
            <h3>Game in Progress</h3>
            <div id="players-display" style="margin-bottom:15px; font-weight:600; color:#ccc;"></div>
            
            <div id="move-history-container" style="background:rgba(0,0,0,0.2); border:1px solid #444; border-radius:4px; margin-bottom:15px;">
              <div id="move-list" style="height:120px; overflow-y:auto; padding:8px; font-family:monospace; font-size:0.95em; color:#ddd; display:flex; flex-wrap:wrap; align-content:flex-start; gap:4px;">
                <div style="width:100%; text-align:center; color:#777; font-style:italic;">Moves will appear here...</div>
              </div>
              <div style="display:flex; width:100%; box-sizing:border-box; border-top:1px solid #444;">
                <button id="nav-start" class="ctrl small" style="flex:1; min-width:0; border:none; border-right:1px solid #444; border-radius:0;">&lt;&lt;</button>
                <button id="nav-prev" class="ctrl small" style="flex:1; min-width:0; border:none; border-right:1px solid #444; border-radius:0;">&lt;</button>
                <button id="nav-next" class="ctrl small" style="flex:1; min-width:0; border:none; border-right:1px solid #444; border-radius:0;">&gt;</button>
                <button id="nav-end" class="ctrl small" style="flex:1; min-width:0; border:none; border-radius:0;">&gt;&gt;</button>
              </div>
            </div>
            
            <div style="display:flex; gap:10px;">
              <button id="hint-btn" class="ctrl secondary" style="flex:1; display:none;">Ã°Å¸â€™Â¡ Hint</button>
              <button id="end-game-btn" class="ctrl danger" style="flex:1;">Resign</button>
            </div>
            <div id="hint-text" style="margin-top:10px; font-size:0.9em; color:#ffff80; min-height:1.2em;"></div>
          </div>

          <div id="result-panel" class="panel" style="display:none">
            <h3>Result</h3>
            <div id="result-banner" style="margin-top:8px;font-weight:700"></div>
            <div id="result-reason" style="margin-top:6px;color:var(--muted)"></div>
            <div style="margin-top:8px">
              <button id="download-final-pgn" class="ctrl small">Download PGN</button>
              <button id="new-game-btn" class="ctrl small">New Game</button>
            </div>
          </div>

            <div class="accordion">
          <div class="accordion-item">
            </div>
          <!-- Move list removed per user request -->
        </div>
      </div>
    </div>

    <script src="/static/vendor/jquery-3.6.0.min.js"></script>
    <script src="/static/vendor/chessboard-1.0.0.min.js"></script>
    <script src="/static/vendor/chess.min.js"></script>

    <!-- Promotion modal (hidden by default) -->
    <div id="promotion-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="promo-title">
      <div class="modal-content">
        <div id="promo-title">Choose promotion piece</div>
        <div class="promo-buttons">
          <button class="promo-btn" data-piece="q"><img class="promo-img" alt="Queen"/><span class="promo-label">Q</span></button>
          <button class="promo-btn" data-piece="r"><img class="promo-img" alt="Rook"/><span class="promo-label">R</span></button>
          <button class="promo-btn" data-piece="b"><img class="promo-img" alt="Bishop"/><span class="promo-label">B</span></button>
          <button class="promo-btn" data-piece="n"><img class="promo-img" alt="Knight"/><span class="promo-label">N</span></button>
        </div>
        <button id="promo-cancel" class="promo-cancel">Cancel</button>
      </div>
    </div>

    <!-- popout modal removed; move list is permanent below the right-side accordion -->

    <script>
      // Expose server-side v1 flag to client JS
      window.V1_MODE = {{ 'true' if v1_mode else 'false' }};
      window.DEBUG_MODE = {{ 'true' if debug_mode else 'false' }};
    </script>
    {% if debug_mode %}
    <!-- Development-only debug panel (read-only). Visible only when Flask debug is enabled. -->
    <div id="dev-debug-panel" style="position:fixed;right:8px;bottom:8px;z-index:1000;background:#fff;border:1px solid #ccc;padding:8px;font-size:12px;max-width:300px;box-shadow:0 2px 6px rgba(0,0,0,0.2);opacity:0.95">
      <div style="font-weight:700;margin-bottom:6px">DEV: Debug Panel</div>
      <div id="dev-preset-name">Preset: -</div>
      <div id="dev-engine-time">Engine time: -</div>
      <div id="dev-engine-skill">Engine skill: -</div>
      <div id="dev-randomness">Randomness/blunder persona: -</div>
      <div id="dev-game-status">Game: -</div>
    </div>
    <script>
    (function(){
      function refresh(){
        // Read selected opponent/persona from the DOM if available
        var selEl = document.getElementById('engine-persona');
        var sel = selEl ? selEl.value : null;
        // Fetch dev presets (will be available only when debug endpoints are enabled)
        fetch('/api/dev/presets').then(function(r){ return r.json(); }).then(function(d){
          if(d && d.ok && d.presets && sel){
            var p = d.presets[sel.toLowerCase()];
            if(p){
              document.getElementById('dev-preset-name').textContent = 'Preset: ' + (p.display_name || sel);
              document.getElementById('dev-engine-time').textContent = 'Engine time: ' + (p.engine_time == null ? '-' : p.engine_time);
              document.getElementById('dev-engine-skill').textContent = 'Engine skill: ' + (p.engine_skill == null ? '-' : p.engine_skill);
              document.getElementById('dev-randomness').textContent = 'Randomness/blunder persona: ' + (p.engine_persona || '-');
            }
          }
        }).catch(function(){});

        // Fetch simple game lifecycle info
        fetch('/api/dev/game_status').then(function(r){ return r.json(); }).then(function(d){
          if(d && d.ok){
            var txt = 'Status: ' + (d.status || '-') + (d.status === 'ENDED' ? (' | ' + (d.end_reason || '') + ' | ' + (d.result || '')) : '');
            document.getElementById('dev-game-status').textContent = txt;
          }
        }).catch(function(){});
      }
      // initial refresh and periodic updates
      setTimeout(refresh, 200);
      setInterval(refresh, 2000);
    })();
    </script>
    {% endif %}
    <script src="/static/main.js?v={{ main_js_version }}"></script>
    <!-- Feedback Button (floating bottom-right) -->
    <button id="feedbackBtn" class="feedback-button">ðŸ’¬ Feedback</button>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <span class="close" role="button" aria-label="Close">&times;</span>
            <h2>Send Feedback</h2>
            <p>Help improve this chess board! Share your thoughts, report bugs, or suggest features.</p>
            
            <form id="feedbackForm">
                <label for="userName">Name (optional):</label>
                <input type="text" id="userName" name="userName" placeholder="Your name">
                
                <label for="userFeedback">Your feedback:</label>
                <textarea id="userFeedback" name="userFeedback" rows="6" placeholder="What would you like to share?" required></textarea>
                
                <div class="button-group">
                    <button type="submit" class="submit-btn">Send Feedback</button>
                    <button type="button" class="cancel-btn" onclick="closeFeedbackModal()">Cancel</button>
                </div>
            </form>
            
            <div id="feedbackSuccess" style="display: none;">
                <p>âœ… Thanks! Your feedback has been received.</p>
            </div>
        </div>
    </div>

    <style>
    /* Minimal styles for feedback modal/button */
      .feedback-button{position:fixed;right:18px;bottom:18px;z-index:1200;background:#4CAF50;color:#fff;border:none;padding:10px 14px;border-radius:999px;box-shadow:0 4px 10px rgba(76,175,80,0.25);cursor:pointer}
    .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1201}
    .modal[aria-hidden="true"]{display:none}
    .modal-content{background:#111;color:#fff;padding:18px;border-radius:8px;max-width:520px;width:92%;box-shadow:0 6px 24px rgba(0,0,0,0.6)}
    .modal-content input,.modal-content textarea{width:100%;padding:8px;margin:6px 0 12px;border-radius:6px;border:1px solid #444;background:#0b0b0b;color:#fff}
    .modal-content .close{position:absolute;right:12px;top:10px;font-size:20px;cursor:pointer}
    .button-group{display:flex;gap:8px}
    .submit-btn{background:#0b5fff;color:#fff;padding:8px 12px;border-radius:6px;border:none}
    .cancel-btn{background:transparent;color:#ddd;border:1px solid #444;padding:8px 12px;border-radius:6px}
    </style>

    <script>
    // Feedback Modal Functions
    const feedbackModal = document.getElementById('feedbackModal');
    const feedbackBtn = document.getElementById('feedbackBtn');
    const feedbackForm = document.getElementById('feedbackForm');
    const feedbackSuccess = document.getElementById('feedbackSuccess');
    const closeBtn = document.querySelector('.close');

    // Open modal
    if (feedbackBtn) {
      feedbackBtn.onclick = function() {
        if (feedbackModal) feedbackModal.setAttribute('aria-hidden', 'false');
      }
    }

    // Close modal
    if (closeBtn) {
      closeBtn.onclick = function() {
        closeFeedbackModal();
      }
    }

    function closeFeedbackModal() {
      if (feedbackModal) feedbackModal.setAttribute('aria-hidden', 'true');
      if (feedbackForm) { feedbackForm.style.display = 'block'; feedbackForm.reset(); }
      if (feedbackSuccess) feedbackSuccess.style.display = 'none';
    }

    // Close if clicking outside modal
    window.onclick = function(event) {
      if (event.target === feedbackModal) {
        closeFeedbackModal();
      }
    }

    // Handle form submission
    if (feedbackForm) {
      feedbackForm.onsubmit = async function(e) {
        e.preventDefault();

        const formData = new FormData(feedbackForm);
        const data = {
          name: formData.get('userName') || 'Anonymous',
          feedback: formData.get('userFeedback')
        };

        try {
          const response = await fetch('/submit-feedback', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });

          if (response.ok) {
            feedbackForm.style.display = 'none';
            feedbackSuccess.style.display = 'block';
            setTimeout(closeFeedbackModal, 2000); // Close after 2 seconds
          } else {
            alert('Failed to send feedback.');
          }
        } catch (error) {
          alert('Failed to send feedback. Please try again.');
        }
      }
    }
    </script>
  </body>
</html>
